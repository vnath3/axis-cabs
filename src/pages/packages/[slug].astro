---
import '../../styles/globals.css';
import Header from '@/components/Header.astro';
import Footer from '@/components/Footer.astro';
import FAQ from '@/components/FAQ.astro';
import { packages } from '@/data/packages';
import { destinations } from '@/data/destinations';
import pricing from '@/data/pricing.json';
import Analytics from '@/components/Analytics.astro';

export async function getStaticPaths() {
  return packages.map((p) => ({ params: { slug: p.slug } }));
}

const { slug } = Astro.params;
const entry = packages.find((p) => p.slug === slug);
if (!entry) return Astro.redirect('/');

const band = pricing.packages?.[slug!];
const dest = destinations.find(d => d.slug.replace(/^\/packages\//, '') === slug);
const WA = (import.meta.env.PUBLIC_WHATSAPP_NUMBER || '+919922333305').replace(/\D/g, '');
const waText = encodeURIComponent(`Hi Axis Cabs ðŸ‘‹\nI'm interested in "${entry.title}". Please share details.`);
const waHref = `https://wa.me/${WA}?text=${waText}`;
const reviewCount = entry.reviews.length;
const averageRating = reviewCount > 0
  ? entry.reviews.reduce((sum, r) => sum + r.rating, 0) / reviewCount
  : 0;
function formatINR(n: number) {
  try {
    return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(n);
  } catch {
    return `â‚¹${n.toLocaleString('en-IN')}`;
  }
}
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{entry.title}</title>
    <meta name="description" content={entry.summary} />
    <link rel="icon" href="/favicon.svg" />
    <Analytics />
  </head>
  <body>
    <Header />
    {entry.images.length > 0 && (
      <section id="gallery" class="max-w-6xl mx-auto px-4 py-4">
        <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
          {entry.images.map((img, i) => (
            <button class="group" data-gallery-btn data-src={img.src} data-story={img.story} data-alt={img.alt} aria-label={`Open image ${i+1}`}>
              <img src={img.src} alt={img.alt} class="w-full h-40 md:h-56 object-cover rounded-lg" />
            </button>
          ))}
        </div>
        <dialog id="gallery-modal" class="p-0 rounded-lg">
          <img id="modal-img" src="" alt="" class="w-full max-h-[80vh] object-cover" />
          <div class="p-4">
            <p id="modal-story" class="text-sm text-slate-700"></p>
            <button id="modal-close" class="mt-3 text-sm underline">Close</button>
          </div>
        </dialog>
        <script is:inline>
          {`(() => {
            const modal = document.getElementById('gallery-modal');
            const img = document.getElementById('modal-img');
            const story = document.getElementById('modal-story');
            const closeBtn = document.getElementById('modal-close');
            document.querySelectorAll('[data-gallery-btn]').forEach(btn => {
              btn.addEventListener('click', () => {
                img.src = btn.getAttribute('data-src') || '';
                img.alt = btn.getAttribute('data-alt') || '';
                story.textContent = btn.getAttribute('data-story') || '';
                modal.showModal();
              });
            });
            closeBtn?.addEventListener('click', () => modal.close());
          })();`}
        </script>
      </section>
    )}
    <section class="max-w-6xl mx-auto px-4 py-6">
      <h1 class="text-3xl font-bold">{entry.title}</h1>
      <p class="mt-2 text-lg opacity-80">{entry.summary}</p>
      {dest && (
        <div class="mt-4 flex flex-wrap gap-2">
          {dest.highlights.map(h => <span class="text-xs font-medium px-2.5 py-1 rounded-full bg-gray-100">{h}</span>)}
        </div>
      )}
      {dest && (
        <div class="mt-4 flex flex-wrap items-center gap-4">
          <span class="text-2xl font-bold">{formatINR(dest.priceFromINR)}</span>
          <span class="opacity-70">{dest.duration}</span>
        </div>
      )}
      <div class="mt-4">
        <a href={waHref} class="btn-primary">Book on WhatsApp</a>
      </div>
    </section>
    <main class="mx-auto max-w-6xl px-4 grid md:grid-cols-3 gap-8">
      <div class="md:col-span-2">
        <section class="card">
          <h2 class="text-xl font-bold">Price Bands</h2>
          <p class="opacity-80 mt-2">
            Sedan â‚¹{band?.sedan_band?.[0] ?? 'â€”'}â€“â‚¹{band?.sedan_band?.[1] ?? 'â€”'}
            â€¢ SUV â‚¹{band?.suv_band?.[0] ?? 'â€”'}â€“â‚¹{band?.suv_band?.[1] ?? 'â€”'}
          </p>
          <p class="text-sm mt-1 opacity-70">Inclusions: AC cab, fuel, driver allowance. Exclusions: entry tickets, meals, hotel.</p>
        </section>
        <section class="mt-6">
          <h3 class="text-lg font-bold mb-3">What you'll experience</h3>
          <div class="space-y-3">
            {entry.days.map((d) => (
              <div class="card">
                <h4 class="font-semibold">{d.day}</h4>
                <ul class="list-disc list-inside text-sm mt-2">
                  {d.items.map(i => <li>{i}</li>)}
                </ul>
              </div>
            ))}
            <details class="card">
              <summary class="cursor-pointer font-semibold">What's included?</summary>
              <ul class="list-disc list-inside text-sm mt-2">
                <li>AC cab with driver</li>
                <li>Fuel &amp; tolls</li>
              </ul>
            </details>
            <details class="card">
              <summary class="cursor-pointer font-semibold">What's not included?</summary>
              <ul class="list-disc list-inside text-sm mt-2">
                <li>Entry tickets</li>
                <li>Meals</li>
              </ul>
            </details>
          </div>
        </section>
        {entry.faqs.length > 0 && (
          <section class="mt-6">
            <h3 class="text-lg font-bold mb-3">FAQ</h3>
            <FAQ items={entry.faqs} />
          </section>
        )}
          {entry.reviews.length > 0 && (
          <section class="mt-6">
            <h3 class="text-lg font-bold mb-1">Reviews</h3>
            <p class="mb-3 text-sm flex items-center gap-1">
              <svg viewBox="0 0 20 20" class="h-4 w-4 fill-amber-400" aria-hidden="true"><path d="M10 15.27 16.18 19l-1.64-7.03L20 7.24l-7.19-.61L10 0 7.19 6.63 0 7.24l5.46 4.73L3.82 19z"/></svg>
              {averageRating.toFixed(1)} ({reviewCount} {reviewCount === 1 ? 'review' : 'reviews'})
            </p>
            <div class="space-y-4">
              {entry.reviews.map(r => (
                <div class="card">
                  <div class="mb-1">
                    {[1,2,3,4,5].map(n => (
                      <svg viewBox="0 0 20 20" class={`inline h-4 w-4 ${n <= r.rating ? 'fill-amber-400' : 'fill-slate-200'}`} aria-hidden="true"><path d="M10 15.27 16.18 19l-1.64-7.03L20 7.24l-7.19-.61L10 0 7.19 6.63 0 7.24l5.46 4.73L3.82 19z"/></svg>
                    ))}
                  </div>
                  <p class="text-sm">{r.text}</p>
                  <p class="text-xs mt-2 opacity-70">â€” {r.name}</p>
                </div>
              ))}
            </div>
          </section>
        )}
      </div>
      <aside class="space-y-4">
       <div class="card"><strong>Why Axis Cabs?</strong><p class="text-sm mt-2 opacity-80">Local expertise â€¢ Flexible timing â€¢ Premium support</p></div>
        <div class="card p-4 space-y-4">
          {dest && (
            <div>
              <p class="text-2xl font-bold">{formatINR(dest.priceFromINR)}</p>
              <p class="text-sm opacity-70">{dest.duration}</p>
            </div>
          )}
          <div>
            <label for="vehicle" class="text-sm font-semibold">Vehicle</label>
            <select id="vehicle" class="mt-1 w-full border rounded px-2 py-1">
              <option value="sedan">Sedan (1â€“4) â€” {formatINR(band?.sedan_band?.[0] ?? dest?.priceFromINR ?? 0)}</option>
              <option value="suv">SUV (1â€“6) â€” {formatINR(band?.suv_band?.[0] ?? dest?.priceFromINR ?? 0)}</option>
            </select>
          </div>
          <div>
            <p class="text-sm font-semibold">Add-ons</p>
            <div class="mt-2 space-y-1">
              <label class="flex items-center gap-2 text-sm"><input type="checkbox" />Certified Guide (English/Hindi) {formatINR(1200)}</label>
              <label class="flex items-center gap-2 text-sm"><input type="checkbox" />Premium Hotel Upgrade {formatINR(4200)}</label>
              <label class="flex items-center gap-2 text-sm"><input type="checkbox" />Local Food Tasting {formatINR(1200)}</label>
            </div>
          </div>
          <div class="flex flex-col gap-2">
            <a href={waHref} class="btn-primary w-full">WhatsApp Quote</a>
            <button class="border border-primary text-primary rounded-xl px-5 py-3 font-semibold w-full">Book Now</button>
          </div>
          <p class="text-xs text-center opacity-70">Transparent fares â€¢ 24Ã—7 support</p>
        </div>

      </aside>
    </main>
    <Footer />
  </body>
</html>
