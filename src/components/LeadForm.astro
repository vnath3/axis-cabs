---
import { LeadSchema } from "@/lib/validators";
import { waPrefillText } from "@/lib/whatsapp";
const WA = import.meta.env.PUBLIC_WHATSAPP_NUMBER || '+919922333305';

// NOTE: This component posts to /api/lead for server-side validation & Supabase insert.
---
<form id="lead" class="card" onsubmit="return false">
  <div class="grid md:grid-cols-2 gap-4">
    <input required name="from_city" placeholder="From City" class="border rounded-xl px-4 py-3" />
    <input required name="to_city" placeholder="To City" class="border rounded-xl px-4 py-3" />
    <input required name="date" type="date" class="border rounded-xl px-4 py-3" />
    <input required name="time" type="time" class="border rounded-xl px-4 py-3" />
    <input required name="pax" type="number" min="1" max="12" placeholder="Passengers" class="border rounded-xl px-4 py-3" />
    <input name="bags" type="number" min="0" max="12" placeholder="Bags" class="border rounded-xl px-4 py-3" />
    <input required name="name" placeholder="Your Name" class="border rounded-xl px-4 py-3" />
    <input required name="whatsapp" placeholder="WhatsApp (+91...)" class="border rounded-xl px-4 py-3" />
    <textarea name="notes" placeholder="Notes (optional)" class="md:col-span-2 border rounded-xl px-4 py-3"></textarea>
  </div>
  <div class="mt-4 flex gap-3">
    <button class="btn-primary" id="btn-wa">Get Instant Quote on WhatsApp</button>
    <button class="inline-flex items-center px-5 py-3 rounded-xl border border-primary font-semibold" id="btn-submit">Submit</button>
  </div>
  <p id="msg" class="mt-3 text-sm"></p>

  <script>
    async function postLead(form) {
      const fd = new FormData(form);
      const payload = Object.fromEntries(fd.entries());
      const res = await fetch('/api/lead', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      return await res.json();
    }

    const formEl = document.currentScript.closest('form');
    const btnWa = formEl.querySelector('#btn-wa');
    const btnSubmit = formEl.querySelector('#btn-submit');
    const msg = formEl.querySelector('#msg');

    btnWa.addEventListener('click', async () => {
      try {
        const data = await postLead(formEl);
        if (data?.ok) {
          const text = `Ride request:%0AFrom: ${encodeURIComponent(data.lead.from_city)}%0ATo: ${encodeURIComponent(data.lead.to_city)}%0ADate/Time: ${encodeURIComponent(data.lead.date)} ${encodeURIComponent(data.lead.time)}%0APax/Bags: ${encodeURIComponent(data.lead.pax)}/${encodeURIComponent(data.lead.bags ?? '0')}%0ANotes: ${encodeURIComponent(data.lead.notes ?? '')}`;
          window.location.href = `https://wa.me/${encodeURIComponent(import.meta.env.PUBLIC_WHATSAPP_NUMBER || '+919922333305')}?text=${text}`;
        } else { msg.textContent = data?.error || 'Please check your inputs.'; }
      } catch (e) { msg.textContent = 'Network error. Try again.'; }
    });

    btnSubmit.addEventListener('click', async () => {
      try {
        const data = await postLead(formEl);
        msg.textContent = data?.ok ? 'Thanks! Our team will contact you shortly.' : (data?.error || 'Please check your inputs.');
      } catch (e) { msg.textContent = 'Network error. Try again.'; }
    });
  </script>
</form>